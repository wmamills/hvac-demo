#!/bin/bash

MY_DIR=$(cd $(dirname $0); pwd)
. $MY_DIR/../build_common.sh

disk_common_buildroot() {
	ORIG_CPIO=virtio_msg_rootfs.cpio
	URL_CPIO_BASE=http://people.linaro.org/~manos.pitsidianakis
	if [ ! -r build/disk/$ORIG_CPIO ]; then
		echo "****** Fetch original buildroot rootfs cpio image"
		mkdir -p build/disk
		(cd build/disk; wget $URL_CPIO_BASE/$ORIG_CPIO)
		# source is not compressed for some reason
		gzip <build/disk/$ORIG_CPIO >build/disk/$ORIG_CPIO.gz
	fi
}

disk_common_debian() {
	# make sure we have a copy of the upstream disk image
	ORIG_DISK=debian-12-nocloud-arm64.qcow2
	URL_BASE=https://cloud.debian.org/images/cloud/bookworm/latest
	if [ ! -r build/disk/$ORIG_DISK ]; then
		echo "****** Fetch original debian disk image"
		mkdir -p build/disk
		(cd build/disk; wget $URL_BASE/$ORIG_DISK)
	fi

	# now make a copy of the template and expand it
	BIG_DISK=debian-12-arm64-big.qcow2
	if [ ! -r build/disk/$BIG_DISK ]; then
		# side effect /dev/sda15 -> /dev/sda1 & /dev/sda1 -> /dev/sda2
		echo "****** resize debian disk image"
		qemu-img create -f qcow2 build/disk/debian-12-arm64-big.qcow2 10G
		virt-resize --expand /dev/sda1 \
			build/disk/$ORIG_DISK \
			build/disk/debian-12-arm64-big.qcow2
	fi
}

buildroot_mixins_common() {
	NAME=$1; shift
	disk_common_buildroot

	echo "****** Create composite cpio.gz image for $NAME"

	# our mixins for minimal & composite initrd cpio
	TOP=$PWD
	rm -rf build/mixins/$NAME || true
	mkdir -p build/mixins/$NAME
	for ITEM in mixins/minimal "$@"; do
		if [ -d $ITEM ]; then
			cp -a $ITEM/. build/mixins/$NAME
		else
			case $ITEM in
			*.tar.gz)
				tar xzf $ITEM -C build/mixins/$NAME
				;;
			*)
				echo "Don't know how to handle $ITEM"
				exit 2
				;;
			esac
		fi
	done
	(cd build/mixins/$NAME; find . | fakeroot cpio -H newc -o 2>/dev/null |
		gzip >$TOP/build/mixins-$NAME.cpio.gz)

	# build the composite even if not everyone will use it
	cat build/disk/$ORIG_CPIO.gz \
		build/mixins-$NAME.cpio.gz \
		>build/$NAME-rootfs.cpio.gz
}

debian_mixins_common() {
	NAME=$1; shift

	echo "****** Create $NAME-mixins.tar.gz"
	TOP=$PWD
	rm -rf build/mixins/$NAME || true
	mkdir -p build/mixins/$NAME
	for DIR in mixins/debian "$@"; do
		cp -a $DIR/. build/mixins/$NAME
	done

	# our mixins for debian
	fakeroot tar czf build/mixins-$NAME.tar.gz -C build/mixins/$NAME .
}

build_disk_demo1_guest() {
	buildroot_mixins_common demo1 demo1.d/mixins/qemu1-guest
}

build_disk_demo2a() {
	buildroot_mixins_common demo2a demo2a.d/mixins/qemu2
}

build_disk_demo2b() {
	buildroot_mixins_common demo2b-kvm demo2b.d/mixins/qemu2-guest{,-kvm}
	buildroot_mixins_common demo2b-xen demo2b.d/mixins/qemu2-guest
}

build_disk_debian_mixins() {
	debian_mixins_common debian \
		demo1.d/mixins/debian \
		demo2b.d/mixins/debian \
		demo3.d/mixins/debian

}

build_disk_debian() {
	disk_common_debian
	disk_common_buildroot
	(build_disk_demo1_guest)
	(build_disk_demo2b)
	(build_disk_debian_mixins)

	echo "****** Modify a disk image copy for debian based demos"
	rm -f build/demo*-disk.qcow2
	rm -f build/disk.qcow2

	# now make a copy of the (expanded) template
	cp build/disk/$BIG_DISK build/disk.qcow2

	# collect the stuff we need to add
	guestfish --rw -a build/disk.qcow2 <<EOF
run
mount /dev/sda2 /
mkdir /opt/qemu-upstream
mkdir /opt/qemu-msg
tar-in build/linux-upstream-modules.tar.gz / compress:gzip
tar-in build/qemu-upstream-arm64.tar.gz /opt/qemu-upstream compress:gzip
tar-in build/qemu-msg-arm64.tar.gz /opt/qemu-msg compress:gzip
tar-in build/mixins-debian.tar.gz / compress:gzip
upload build/vhost-device-i2c /root/vhost-device-i2c
upload build/xen-vhost-frontend /root/xen-vhost-frontend
upload build/xen-upstream.deb /root/xen-upstream.deb
upload build/xen-virtio-msg.deb /root/xen-virtio-msg.deb
upload build/devmem2 /root/devmem2
upload build/uio_ivshmem_test /root/uio_ivshmem_test
upload build/demo1-rootfs.cpio.gz  /root/demo1-rootfs.cpio.gz
upload build/demo2b-kvm-rootfs.cpio.gz /root/demo2b-kvm-rootfs.cpio.gz
upload build/demo2b-xen-rootfs.cpio.gz /root/demo2b-xen-rootfs.cpio.gz
upload build/linux-virtio-msg-Image /root/linux-virtio-msg-Image
upload build/linux-upstream-Image /root/linux-upstream-Image
EOF
}

build_disk() {
	(build_disk_debian)
	(build_disk_demo2a)
}

main "$@"
